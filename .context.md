# Development Context (Integrated)

## 1. Current Goals (현재 목표)

### A. 도메인/엔티티 인프라

* [ ] **ERD 기반 키/제약 수기 확정**

    * PK/FK
    * Unique / Index
    * Cascade / Nullable 정책
* [ ] **신규 엔티티 인프라 준비**

    * 패키지 구조 확정
    * BaseEntity / Auditing 전략 정리
* [ ] **기본 스캐폴딩**

    * Repository / Test 기본 골격

### B. 인증/보안 (JWT Phase 2)

* [x] **비밀번호 만료 정책 (90일)**
    * `UserEntity`에 `password_changed_at` 필드 추가
    * 로그인 시 `passwordExpired` 플래그 반환
    * 비밀번호 변경 API (`POST /auth/change-password`) 구현
* [ ] **로그아웃 / 전체 로그아웃**
* [ ] **Access Token 블랙리스트**
* [ ] **Refresh Token Rotation + 동시성 제어**

    * Redis + Lua
* [ ] **refresh_tokens 테이블**

    * 스키마 정의
    * 마이그레이션
    * 테스트 추가

---

## 2. Recent Changes (최근 변경 사항)

### 2026-01-30

* `fix(dev)` 예측 보고서 콘솔 토큰 로딩 수정
* `fix(security)` 예측 보고서 콘솔 경로 접근 허용
* `feat(dev)` 예측 보고서 조회 콘솔 페이지 추가
* `feat(report)` 최신 예측값 조회 API/보고서 PDF 다운로드 추가
* `feat(report)` 최신 예측값 조회 로직/테스트 추가
* `feat(dev)` API 콘솔 보고서 발행 테스트 폼 추가
* `feat(report)` 보고서 지표+PDF 발행 API/테스트 추가
* `feat(report)` 보고서 지표+PDF 발행 서비스/테스트 추가
* `feat(dev)` API 콘솔 예측값 적재 UI 추가
* `feat(dev)` API 콘솔 기업 검색 결과 디바운싱 리스트 표시
* `feat(report)` 보고서 지표 예측값 적재 API/테스트 추가
* `feat(report)` 보고서 지표 예측값 적재 서비스/DTO 및 테스트 추가
* `fix(report)` 기업코드 정규화 로직 보완(비숫자 포함도 6자리 미만이면 좌측 패딩)
* `chore(logging)` 비동기 콘솔/파일 로깅 및 롤링 정책 설정
* `feat(report)` 보고서 지표 최신 버전 조회 리포지토리/테스트 추가
* `feat(report)` 보고서 지표 조회 서비스/DTO 및 테스트 추가
* `feat(report)` 보고서 지표 분기별 그룹핑 응답 추가
* `feat(report)` 보고서 지표 그룹 조회 API/문서/테스트 추가
* `feat(dev)` API 콘솔에 보고서 지표 그룹 조회 버튼 추가
* `feat(company)` 기업명 검색 서비스/레포지토리 및 테스트 추가
* `feat(company)` 기업 검색 API/문서/콘솔 연동 추가
* `fix(auth)` Auth Console 로그아웃 버튼 동작 보강
* `test(auth)` 로그아웃 테스트 Role 중복 저장 보정
* `fix(auth)` 로그아웃 전체 처리 토큰 검증(AccessTokenValidator) 반영 및 테스트 추가
* `fix(auth)` 단일 로그아웃 Access 토큰 블랙리스트 및 로그아웃 테스트 보강
* `feat(auth)` Auth Console 보호 API UX 개선
* `fix(test)` 테스트 프로파일 정리 및 엑셀 파서 테스트 메모리 워크북 전환
* `chore(build)` spring-batch-core 의존성 명시 추가
* `refactor(dto)` DTO MapStruct 전환 및 매퍼 주석 보강
* `refactor(company)` DART 동기화 응답 매핑 MapStruct 적용
* `refactor(report)` 보고서 그룹/예측 응답 MapStruct 매핑 추가
* `chore(config)` dev 전용 SQL 로그/Turnstile 기본값 분리
* `chore(config)` dev/prod DB 환경변수 체계 통일
* `docs(config)` env 예시/운영 env 템플릿 정합화
* `chore(config)` prod 이메일 인증 skip=false 유지 및 dev 설정 복구
* `chore(config)` prod 이메일 설정 import 추가
* `docs(config)` .env.example 환경변수 목록 정리
* `docs(config)` README 환경변수 요약 추가

### 2026-01-31

* `chore(deploy)` prod 프로필에서 Redis만 docker compose로 실행
* `chore(config)` prod 파일 업로드 크기 바인딩 분리(FILE_MAX_SIZE_BYTES)
* `feat(file)` files storage_key 컬럼 추가 및 저장 메타데이터 보강
* `feat(file)` S3 presigned 다운로드 리졸버 추가
* `test(file)` 다운로드 presigned 리다이렉트 통합 테스트 추가
* `fix(security)` actuator health 접근 허용
* `test(security)` 헬스체크 접근 테스트 추가
* `chore(auth)` 리프레시 토큰 쿠키 SameSite/secure 설정 분리

### 2026-02-01

* `fix(security)` 공개 경로 축소 및 로그아웃 인증 요구 반영
* `feat(auth)` 이메일 인증 리다이렉트 옵션 추가
* `chore(dev)` 인증 콘솔 경로 /dev/*로 정리 및 템플릿 링크 갱신
* `refactor(dev)` 인증 콘솔 컨트롤러 DevConsoleController로 통합
* `refactor(dev)` dev 카테고리 API를 DevConsoleController로 통합
* `fix(web)` favicon 요청 처리 추가
* `feat(file)` 파일 다운로드 URL 조회 API(/files/{id}/url) 및 테스트 추가
* `feat(category)` 카테고리 조회 API(/categories) 추가 및 테스트 보강
* `fix(security)` 카테고리 조회 공개 경로 허용
* `chore(config)` CORS 허용 도메인 외부화(프로파일별)
* `chore(prod)` actuator/health 안정화 및 swagger 비활성화
* `fix(db)` H2 storage_key 마이그레이션 추가
* `fix(test)` test 프로파일 Turnstile secret-key 기본값 추가
* `chore(deploy)` prod compose에서 mysql 비활성화

### 2026-01-29

* `feat(report)` 보고서 지표 적재 로그 보강
* `docs(report)` 보고서 지표 업로드 문서 추가
* `feat(dev)` API 콘솔에 보고서 지표 업로드 버튼 추가
* `feat(report)` 보고서 지표 업로드 관리자 API 추가
* `feat(report)` 엑셀 지표 파서 및 테스트 추가
* `feat(report)` 보고서 지표 적재 서비스 및 테스트 추가
* `feat(report)` 분기 계산 유틸 및 보고서 관련 리포지토리 추가
* `chore(dart)` DART 응답 버퍼 상향 및 설정 외부화
* `feat(dev)` API 콘솔에 DART 동기화 실행 버튼 추가
* `feat(auth)` dev 관리자 회원가입 옵션 추가
* `fix(company)` 기업 동기화 JDBC 조회 컴파일 오류 수정
* `docs` DART 기업 동기화 운영 가이드 보강
* `test(company)` DART 기업 동기화 Reader/Processor 테스트 추가
* `chore(batch)` DART 배치 운영 설정(타임아웃/재시도/이력 테이블) 추가
* `feat(company)` DART 기업 동기화 수동 실행 API 및 스케줄러 토글 구성
* `feat(company)` DART 기업 동기화 Reader/Writer 및 JDBC 업서트 로직 추가
* `chore(batch)` DART 기업 동기화 배치 스캐폴딩 추가
* `docs` DART 기업 목록 동기화 요구사항 문서 추가
* `chore(dev/db)` dev datasource를 MySQL로 전환 및 docker compose에 mysql 서비스 추가
* `chore(db)` H2 마이그레이션 경로 분리(db/migration-h2) 및 테스트 설정/문서 경로 갱신
* `chore(db)` metrics 시드 마이그레이션 추가(V5, UPSERT)

### 2026-01-29
* `feat(auth)` 로그인 API 정렬 (`AuthLoginResponse` 도입, 응답에 `UserSummaryDto` 포함)
* `feat(auth)` 회원가입 API 정렬 (`SignupRequest` phone 필드 삭제, username 필드 재정의)
* `feat(auth)` 로그아웃(`POST /auth/logout`) 및 전체 로그아웃(`POST /auth/logout-all`) 구현
* `feat(auth)` Refresh Token을 HttpOnly 쿠키로 전달하도록 변경 및 통합 테스트 반영

### 2026-01-28

* `feat(auth)` 비밀번호 만료 정책(90일) 및 비밀번호 변경 API (`POST /auth/change-password`) 구현
* `feat(user)` UserEntity에 `password_changed_at` 추가 및 마이그레이션(V4)
* `test(auth)` 비밀번호 변경 및 만료 체크 테스트 추가
* `chore(db)` Flyway 도입 및 V1 초기 스키마 마이그레이션 추가 (ddl-auto: validate 전환)
* `refactor(auth/file/post)` ROLE_ 통일, refresh_tokens 스키마 정합화, files/post_files 분리, post_view_counts 도입
* `feat(domain)` companies/quarters/metrics/company_reports 관련 엔티티 스캐폴딩 추가
* `test` CommentIntegrationTest 카테고리 중복 회피 및 EmailVerificationServiceTest TestSecurityConfig 적용
* `chore(db)` H2 전용 Flyway 스키마 추가 및 dev/test DB URL/Flyway 경로 정리, CompaniesEntity CHAR 컬럼 정합
* `test` Auth/File 통합 테스트에서 session 키/파일 매핑 기준 반영 및 보안 테스트 설정 정합
* `fix` UserRoleRepository 컴파일 오류(잘못된 \\t 문자) 수정
* `docs` ERD.md 추가 및 README에 스키마 안내 섹션 추가
* `chore(dev)` Auth Console에서 로그아웃 API 미구현 시 안내/비활성화 처리
* `refactor(audit)` BaseEntity에 createdBy/updatedBy 통합, SecurityAuditorAware 추가 및 userId 클레임/관련 엔티티·테스트 정리

### 2026-01-27

* `chore(security)` CSP Report-Only 헤더 추가 및 정적 리소스 허용 경로 보강
* `feat(dev)` Turnstile 검증 디버그 로그 강화 및 dev 디버그 활성화
* `feat(dev)` Turnstile 콘솔 페이지 추가 및 검증 API 연동
* `feat(dev)` Auth 콘솔 회원가입 폼에 Turnstile 위젯/토큰 입력 추가
* `chore(config)` dev 환경 Turnstile 기본 키 제거 (환경 변수 필수)
* `test(auth)` SignupRequestTest에 Turnstile 토큰 기본값 추가
* `test(auth)` Turnstile 실패 통합 테스트 제거 및 주석 정리

### 2026-01-28

* `docs(swagger)` SENTINEL PoC OpenAPI 스펙 정적 제공 및 Swagger UI 다중 문서 등록

### 2026-01-26

* `chore(build)` CodeBuild gradlew 실행 권한 보정 (buildspec)
* `feat(dev)` dev 홈 페이지 추가 및 루트 접근 허용
* `chore(deploy)` CodeDeploy 실행 커맨드 dev 고정/nohup 옵션 적용
* `chore(deploy)` CodeDeploy 재시작 안정화 (stop/start 스크립트 보강)

### 2026-01-25

* `feat(swagger)` 핵심 DTO Swagger 스키마 추가
* `feat(swagger)` 파일 DTO Swagger 스키마 추가
* `feat(swagger)` 핵심 컨트롤러 Swagger 문서화 (Auth/Post/Comment)
* `feat(swagger)` Swagger 보안/공개 엔드포인트 정리
* `feat(swagger)` 파일 컨트롤러 Swagger 문서화
* `feat(swagger)` 개발/콘솔 및 이메일 인증 API 문서화
* `feat(swagger)` 에러 응답 Swagger 스키마 추가
* `feat(swagger)` API 예외 응답 문서화 (공통 오류 코드)
* `feat(swagger)` Swagger UI 커스텀 테마 적용
* `feat(swagger)` Swagger API 버전 설정 추가
* `feat(swagger)` Swagger 공개 경로 보안 허용
* `feat(swagger)` OpenAPI 기본 설정 및 springdoc 설정 추가
* `chore(deps)` SpringDoc 버전 업데이트 (2.3.0 -> 2.6.0)
* `chore(deps)` SpringDoc 버전 업데이트 (2.6.0 -> 2.8.15)
* `test(file)` test 프로파일 파일 스토리지 스텁 설정 추가

### 2026-01-23

* `feat(file)` 파일 조회/다운로드 API 및 콘솔 목록 기능 추가
* `feat(dev)` 파일 업로드 콘솔 페이지 추가
* `test(file)` 파일 업로드 통합/설정 테스트 추가
* `test(file)` 파일 업로드 검증/스토리지 단위 테스트 추가
* `feat(file)` 파일 업로드 커스텀 에러코드/예외 추가
* `feat(file)` 전역 파일 업로드 설정 및 검증기 추가
* `feat(file)` 파일 업로드 기본 구성 추가 (저장소/서비스/컨트롤러/설정/마이그레이션)
* `feat(file)` files 엔티티 추가
* `refactor(service)` Post/Comment 서비스에 UserEntity/ID 전달로 중복 조회 제거
* `feat(security)` @CurrentUser 리졸버 추가 및 Post/Comment 컨트롤러 적용
* `test(config)` 테스트용 JavaMailSender 모킹 빈 추가
* `chore(config)` dev 프로파일에서 application-email.yml import 추가
* `feat(auth)` 이메일 인증 컨트롤러/서비스 및 회원가입 연동 추가
* `feat(user)` 이메일 인증 엔티티/리포지토리/마이그레이션 추가
* `chore(config)` 메일 스타터/메일 설정 파일 추가
* `test(user)` 이메일 인증 서비스 테스트 추가
* `refactor(auth)` dev 환경 회원가입 시 이메일 인증 스킵 처리 및 테스트 보강
* `chore(dev)` Redis docker compose 파일 추가
* `chore(dev)` Redis compose 파일 docker-compose.yml로 통합
* `chore(dev)` docker compose dev/prod 오버라이드 파일 추가
* `chore(dev)` docker compose override 표준화 (override 추가, dev 파일 제거)
* `feat(auth)` 미인증 로그인 응답 분리 및 회원가입 이메일 발송 테스트 보강
* `feat(auth)` 이메일 인증 링크 base-url 설정 추가
* `chore(config)` prod 이메일 인증 base-url 설정 추가

### 2026-01-22

* `feat(posts)` 게시글 JWT 기반 컨트롤러 추가 및 subject(UUID) 검증 처리
* `feat(posts)` 게시글 목록 페이징 응답(PageRequest/PageResponse) 적용
* `test(posts)` 게시글 JWT 검증/페이징 통합 테스트 추가
* `test(service)` PostService/UserDomainService 단위 테스트 추가
* `test(auth)` AccessTokenBlacklistService 단위 테스트 추가
* `test(repo)` PostsRepository/CommentsRepository DataJpaTest 추가
* `feat(comment)` 댓글 CRUD 컨트롤러 추가 및 JWT 기반 처리
* `test(comment)` 댓글 CRUD 컨트롤러 통합 테스트 추가
* `refactor(error)` CommonException 전역 처리 추가

### 2026-01-21

* `test(auth)` 로그인 **통합 테스트** 추가 (Redis Testcontainers)
* `test(auth)` AuthService **실패 케이스 단위 테스트**
* `test(security)` 테스트용 `TestSecurityConfig` 추가 및 JWT 키 파일 의존 제거
* `chore(test)` Testcontainers 의존성 최소화
* `refactor(error)` 전역 예외 처리 통합

    * 공통 에러 코드
    * GlobalExceptionHandler
* `feat(domain)` tags / post_tags ERD & 엔티티 / 테스트 추가
* `test` posts/likes/categories/tag 엔티티 테스트를 DataJpaTest로 전환 (JWT 키 의존성 회피)
* `docs` AGENTS 영어 예외 규칙 확장 (개인 로그 선호 반영)
* `test` posts 연관관계 매핑 및 엔티티 테스트 추가
* `test(posts)` User 게시글 CRUD 컨트롤러 통합 테스트 추가
* `test` Tag/PostTags 엔티티 테스트 SpringBootTest 전환 및 TestSecurityConfig 적용
* `test` post 엔티티 테스트 패키지 정리

### 2026-01-20

* `feat(auth)` **JWT 인증 Phase 1 구성**
* `feat(auth)` 레거시 `ROLE_` 호환 및 컷오프 정책
* `test(auth)` JWT / Auth / RefreshToken 단위 테스트
* `feat(user)` User / Role 엔티티 및 보안 어댑터
* `feat(domain)` 게시글 / 카테고리 / 좋아요 엔티티 추가
* `chore` BigProject.sql 제거 및 추적 정책 정리
* `docs`

    * AGENTS.md 환경 정보
    * 영어 예외 규칙
    * 테스트/주석 가이드
    * 개인 로그 규칙 및 로그 파일 생성

### 2026-01-19

* `chore(config)` prod/dev YAML 분리
* `.env.example` 제공
* 설정/템플릿 변경 커밋

---

## 3. Next Steps (우선순위 기준)

### 1️⃣ ERD & 엔티티 인프라

1. ERD 기반 **키 / 제약 수기 확정**
2. 엔티티 공통 정책

    * ID 전략
    * Soft Delete 여부
    * Auditing 필드
3. 패키지 구조 확정 및 스캐폴딩

### 2️⃣ JWT Phase 2

1. 로그아웃 / 전체 로그아웃 API
2. Access Token 블랙리스트 (Redis)
3. Refresh Rotation

    * Lua 기반 동시성 제어
4. refresh_tokens 마이그레이션 + 테스트

---

## 4. Known Issues / Pending

* ❗ **ERD SQL에 키/제약 정보 누락**
  → 수기 정의 필요
* ❗ **refresh_tokens 테이블 미구현**
* ❗ **RS256 키 파일 준비 필요**
* ❗ **User 게시글 CRUD는 임시로 `X-User-Id` 헤더를 사용**
  → JWT/인증 적용 시 `CustomUserDetails` 기반으로 교체 필요 (JWT Phase 2 연계)

---

## 5. History (요약 로그)

* **2026-01-30**

* 기업코드 정규화 로직 보완(비숫자 포함도 6자리 미만이면 좌측 패딩)

* **2026-01-29**

    * 보고서 지표 적재 로그 보강
    * 보고서 지표 업로드 문서 추가
    * API 콘솔에 보고서 지표 업로드 버튼 추가
    * 보고서 지표 업로드 관리자 API 추가
    * 엑셀 지표 파서 및 테스트 추가
    * 보고서 지표 적재 서비스 및 테스트 추가
    * 분기 계산 유틸 및 보고서 관련 리포지토리 추가
    * DART 응답 버퍼 상향 및 설정 외부화
    * API 콘솔에 DART 동기화 실행 버튼 추가
    * dev 관리자 회원가입 옵션 추가
    * 기업 동기화 JDBC 조회 컴파일 오류 수정
    * DART 기업 동기화 운영 가이드 보강
    * DART 기업 동기화 Reader/Processor 테스트 추가
    * DART 배치 운영 설정(타임아웃/재시도/이력 테이블) 추가
    * DART 기업 동기화 수동 실행 API 및 스케줄러 토글 구성
    * DART 기업 동기화 Reader/Writer 및 JDBC 업서트 로직 추가
    * DART 기업 동기화 배치 스캐폴딩 추가
    * DART 기업 목록 동기화 요구사항 문서 추가
    * dev MySQL 전환 및 docker compose mysql 추가
    * H2 마이그레이션 경로 분리 및 테스트 설정/문서 갱신
    * metrics 시드 마이그레이션 추가(UPSERT)

* **2026-01-28**

    * Flyway 도입 및 V1 초기 스키마 마이그레이션 추가
    * ROLE_ 통일, refresh_tokens/파일/조회수 분리 등 ERD 정합화 반영

* **2026-01-26**

    * CodeBuild gradlew 실행 권한 보정 (buildspec)
    * dev 홈 페이지 추가 및 루트 접근 허용
    * CodeDeploy 실행 커맨드 dev 고정/nohup 옵션 적용
    * CodeDeploy 재시작 안정화 (stop/start 스크립트 보강)

* **2026-01-25**

    * test 프로파일 파일 스토리지 스텁 설정 추가

* **2026-01-23**

    * 파일 조회/다운로드 API 및 콘솔 목록 기능 추가
    * 파일 업로드 콘솔 페이지 추가
    * 파일 업로드 통합/설정 테스트 추가
    * 파일 업로드 검증/스토리지 단위 테스트 추가
    * 파일 업로드 커스텀 에러코드/예외 추가
    * 전역 파일 업로드 설정 및 검증기 추가
    * 파일 업로드 기본 구성 추가
    * files 엔티티 추가
    * Post/Comment 서비스에서 중복 사용자 조회 제거
    * @CurrentUser 리졸버 추가 및 컨트롤러 적용
    * 테스트용 JavaMailSender 모킹 빈 추가
    * dev 프로파일에서 이메일 설정 import 적용
    * 이메일 인증 도메인/서비스/컨트롤러 및 회원가입 연동 추가
    * 이메일 인증 마이그레이션과 테스트 추가
    * dev 환경 회원가입 이메일 인증 스킵 처리 및 테스트 보강
    * Redis docker compose 파일 추가
    * Redis compose 파일 docker-compose.yml로 통합
    * docker compose dev/prod 오버라이드 파일 추가
    * docker compose override 표준화 (override 추가, dev 파일 제거)
    * 미인증 로그인 응답 분리 및 회원가입 이메일 발송 테스트 보강
    * 이메일 인증 링크 base-url 설정 추가
    * prod 이메일 인증 base-url 설정 추가

* **2026-01-22**

    * 게시글 API 페이징 및 JWT 기반 컨트롤러 추가
    * 게시글 관련 통합 테스트 보강 및 CommonException 처리 추가

* **2026-01-21**

    * 인증 통합 테스트 및 전역 예외 처리 리팩터링 완료
    * 게시글 CRUD 컨트롤러 테스트 및 엔티티 테스트 설정 보완
* **2026-01-20**

    * JWT Phase 1 완료
    * User/Role + 게시글 도메인 엔티티 구축
    * 테스트/문서/로그 프로토콜 정비
* **2026-01-19**

    * 환경 설정 분리 및 템플릿 정리

* **2026-01-28**

    * SENTINEL PoC OpenAPI 스펙 Swagger UI 연결

---

## 6. 작업 에이전트 워크플로우

1. 작업을 기능/변경 단위로 분리한다.
2. 단위 작업마다 코드 수정 → 관련 테스트 실행 → 커밋을 순서대로 수행한다.
3. 모든 단위 작업 완료 후, 전체 테스트(예: `./gradlew test`)를 한 번 더 실행한다.

---

## 7. Context7 MCP 사용법

### 기본 명령어
- **라이브러리 ID 확인**: `@context7 resolve-library-id <libraryName>`
- **문서 조회**: `@context7 query-docs <libraryId> <query>`

### 예시
```
@context7 resolve-library-id spring-boot
@context7 query-docs /springframework/spring-boot "JPA 설정 방법"
```

### 주요 라이브러리 ID
- Spring Boot: `/springframework/spring-boot`
- Spring Security: `/springframework/spring-security`
- JPA/Hibernate: `/hibernate/hibernate-orm`
- Redis: `/redis/redis`
- JWT: `/jwt/jjwt`
- Testcontainers: `/testcontainers/testcontainers-java`
- H2 Database: `/h2database/h2`
- Lombok: `/projectlombok/lombok`
- QueryDSL: `/querydsl/querydsl`
- Flyway: `/flyway/flyway`
