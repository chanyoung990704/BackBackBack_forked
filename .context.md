# Development Context (Integrated)

## 1. Current Goals (현재 목표)

### A. 도메인/엔티티 인프라

* [ ] **ERD 기반 키/제약 수기 확정**

    * PK/FK
    * Unique / Index
    * Cascade / Nullable 정책
* [ ] **신규 엔티티 인프라 준비**

    * 패키지 구조 확정
    * BaseEntity / Auditing 전략 정리
* [ ] **기본 스캐폴딩**

    * Repository / Test 기본 골격

### B. 인증/보안 (JWT Phase 2)

* [ ] **로그아웃 / 전체 로그아웃**
* [ ] **Access Token 블랙리스트**
* [ ] **Refresh Token Rotation + 동시성 제어**

    * Redis + Lua
* [ ] **refresh_tokens 테이블**

    * 스키마 정의
    * 마이그레이션
    * 테스트 추가

---

## 2. Recent Changes (최근 변경 사항)

### 2026-01-27

* `chore(security)` CSP Report-Only 헤더 추가 및 정적 리소스 허용 경로 보강
* `feat(dev)` Turnstile 검증 디버그 로그 강화 및 dev 디버그 활성화
* `feat(dev)` Turnstile 콘솔 페이지 추가 및 검증 API 연동
* `feat(dev)` Auth 콘솔 회원가입 폼에 Turnstile 위젯/토큰 입력 추가
* `chore(config)` dev 환경 Turnstile 기본 키 제거 (환경 변수 필수)
* `test(auth)` SignupRequestTest에 Turnstile 토큰 기본값 추가
* `test(auth)` Turnstile 실패 통합 테스트 제거 및 주석 정리

### 2026-01-26

* `chore(build)` CodeBuild gradlew 실행 권한 보정 (buildspec)
* `feat(dev)` dev 홈 페이지 추가 및 루트 접근 허용
* `chore(deploy)` CodeDeploy 실행 커맨드 dev 고정/nohup 옵션 적용
* `chore(deploy)` CodeDeploy 재시작 안정화 (stop/start 스크립트 보강)

### 2026-01-25

* `feat(swagger)` 핵심 DTO Swagger 스키마 추가
* `feat(swagger)` 파일 DTO Swagger 스키마 추가
* `feat(swagger)` 핵심 컨트롤러 Swagger 문서화 (Auth/Post/Comment)
* `feat(swagger)` Swagger 보안/공개 엔드포인트 정리
* `feat(swagger)` 파일 컨트롤러 Swagger 문서화
* `feat(swagger)` 개발/콘솔 및 이메일 인증 API 문서화
* `feat(swagger)` 에러 응답 Swagger 스키마 추가
* `feat(swagger)` API 예외 응답 문서화 (공통 오류 코드)
* `feat(swagger)` Swagger UI 커스텀 테마 적용
* `feat(swagger)` Swagger API 버전 설정 추가
* `feat(swagger)` Swagger 공개 경로 보안 허용
* `feat(swagger)` OpenAPI 기본 설정 및 springdoc 설정 추가
* `chore(deps)` SpringDoc 버전 업데이트 (2.3.0 -> 2.6.0)
* `chore(deps)` SpringDoc 버전 업데이트 (2.6.0 -> 2.8.15)
* `test(file)` test 프로파일 파일 스토리지 스텁 설정 추가

### 2026-01-23

* `feat(file)` 파일 조회/다운로드 API 및 콘솔 목록 기능 추가
* `feat(dev)` 파일 업로드 콘솔 페이지 추가
* `test(file)` 파일 업로드 통합/설정 테스트 추가
* `test(file)` 파일 업로드 검증/스토리지 단위 테스트 추가
* `feat(file)` 파일 업로드 커스텀 에러코드/예외 추가
* `feat(file)` 전역 파일 업로드 설정 및 검증기 추가
* `feat(file)` 파일 업로드 기본 구성 추가 (저장소/서비스/컨트롤러/설정/마이그레이션)
* `feat(file)` files 엔티티 추가
* `refactor(service)` Post/Comment 서비스에 UserEntity/ID 전달로 중복 조회 제거
* `feat(security)` @CurrentUser 리졸버 추가 및 Post/Comment 컨트롤러 적용
* `test(config)` 테스트용 JavaMailSender 모킹 빈 추가
* `chore(config)` dev 프로파일에서 application-email.yml import 추가
* `feat(auth)` 이메일 인증 컨트롤러/서비스 및 회원가입 연동 추가
* `feat(user)` 이메일 인증 엔티티/리포지토리/마이그레이션 추가
* `chore(config)` 메일 스타터/메일 설정 파일 추가
* `test(user)` 이메일 인증 서비스 테스트 추가
* `refactor(auth)` dev 환경 회원가입 시 이메일 인증 스킵 처리 및 테스트 보강
* `chore(dev)` Redis docker compose 파일 추가
* `chore(dev)` Redis compose 파일 docker-compose.yml로 통합
* `chore(dev)` docker compose dev/prod 오버라이드 파일 추가
* `chore(dev)` docker compose override 표준화 (override 추가, dev 파일 제거)
* `feat(auth)` 미인증 로그인 응답 분리 및 회원가입 이메일 발송 테스트 보강
* `feat(auth)` 이메일 인증 링크 base-url 설정 추가
* `chore(config)` prod 이메일 인증 base-url 설정 추가

### 2026-01-22

* `feat(posts)` 게시글 JWT 기반 컨트롤러 추가 및 subject(UUID) 검증 처리
* `feat(posts)` 게시글 목록 페이징 응답(PageRequest/PageResponse) 적용
* `test(posts)` 게시글 JWT 검증/페이징 통합 테스트 추가
* `test(service)` PostService/UserDomainService 단위 테스트 추가
* `test(auth)` AccessTokenBlacklistService 단위 테스트 추가
* `test(repo)` PostsRepository/CommentsRepository DataJpaTest 추가
* `feat(comment)` 댓글 CRUD 컨트롤러 추가 및 JWT 기반 처리
* `test(comment)` 댓글 CRUD 컨트롤러 통합 테스트 추가
* `refactor(error)` CommonException 전역 처리 추가

### 2026-01-21

* `test(auth)` 로그인 **통합 테스트** 추가 (Redis Testcontainers)
* `test(auth)` AuthService **실패 케이스 단위 테스트**
* `test(security)` 테스트용 `TestSecurityConfig` 추가 및 JWT 키 파일 의존 제거
* `chore(test)` Testcontainers 의존성 최소화
* `refactor(error)` 전역 예외 처리 통합

    * 공통 에러 코드
    * GlobalExceptionHandler
* `feat(domain)` tags / post_tags ERD & 엔티티 / 테스트 추가
* `test` posts/likes/categories/tag 엔티티 테스트를 DataJpaTest로 전환 (JWT 키 의존성 회피)
* `docs` AGENTS 영어 예외 규칙 확장 (개인 로그 선호 반영)
* `test` posts 연관관계 매핑 및 엔티티 테스트 추가
* `test(posts)` User 게시글 CRUD 컨트롤러 통합 테스트 추가
* `test` Tag/PostTags 엔티티 테스트 SpringBootTest 전환 및 TestSecurityConfig 적용
* `test` post 엔티티 테스트 패키지 정리

### 2026-01-20

* `feat(auth)` **JWT 인증 Phase 1 구성**
* `feat(auth)` 레거시 `ROLE_` 호환 및 컷오프 정책
* `test(auth)` JWT / Auth / RefreshToken 단위 테스트
* `feat(user)` User / Role 엔티티 및 보안 어댑터
* `feat(domain)` 게시글 / 카테고리 / 좋아요 엔티티 추가
* `chore` BigProject.sql 제거 및 추적 정책 정리
* `docs`

    * AGENTS.md 환경 정보
    * 영어 예외 규칙
    * 테스트/주석 가이드
    * 개인 로그 규칙 및 로그 파일 생성

### 2026-01-19

* `chore(config)` prod/dev YAML 분리
* `.env.example` 제공
* 설정/템플릿 변경 커밋

---

## 3. Next Steps (우선순위 기준)

### 1️⃣ ERD & 엔티티 인프라

1. ERD 기반 **키 / 제약 수기 확정**
2. 엔티티 공통 정책

    * ID 전략
    * Soft Delete 여부
    * Auditing 필드
3. 패키지 구조 확정 및 스캐폴딩

### 2️⃣ JWT Phase 2

1. 로그아웃 / 전체 로그아웃 API
2. Access Token 블랙리스트 (Redis)
3. Refresh Rotation

    * Lua 기반 동시성 제어
4. refresh_tokens 마이그레이션 + 테스트

---

## 4. Known Issues / Pending

* ❗ **ERD SQL에 키/제약 정보 누락**
  → 수기 정의 필요
* ❗ **refresh_tokens 테이블 미구현**
* ❗ **RS256 키 파일 준비 필요**
* ❗ **User 게시글 CRUD는 임시로 `X-User-Id` 헤더를 사용**
  → JWT/인증 적용 시 `CustomUserDetails` 기반으로 교체 필요 (JWT Phase 2 연계)

---

## 5. History (요약 로그)

* **2026-01-26**

    * CodeBuild gradlew 실행 권한 보정 (buildspec)
    * dev 홈 페이지 추가 및 루트 접근 허용
    * CodeDeploy 실행 커맨드 dev 고정/nohup 옵션 적용
    * CodeDeploy 재시작 안정화 (stop/start 스크립트 보강)

* **2026-01-25**

    * test 프로파일 파일 스토리지 스텁 설정 추가

* **2026-01-23**

    * 파일 조회/다운로드 API 및 콘솔 목록 기능 추가
    * 파일 업로드 콘솔 페이지 추가
    * 파일 업로드 통합/설정 테스트 추가
    * 파일 업로드 검증/스토리지 단위 테스트 추가
    * 파일 업로드 커스텀 에러코드/예외 추가
    * 전역 파일 업로드 설정 및 검증기 추가
    * 파일 업로드 기본 구성 추가
    * files 엔티티 추가
    * Post/Comment 서비스에서 중복 사용자 조회 제거
    * @CurrentUser 리졸버 추가 및 컨트롤러 적용
    * 테스트용 JavaMailSender 모킹 빈 추가
    * dev 프로파일에서 이메일 설정 import 적용
    * 이메일 인증 도메인/서비스/컨트롤러 및 회원가입 연동 추가
    * 이메일 인증 마이그레이션과 테스트 추가
    * dev 환경 회원가입 이메일 인증 스킵 처리 및 테스트 보강
    * Redis docker compose 파일 추가
    * Redis compose 파일 docker-compose.yml로 통합
    * docker compose dev/prod 오버라이드 파일 추가
    * docker compose override 표준화 (override 추가, dev 파일 제거)
    * 미인증 로그인 응답 분리 및 회원가입 이메일 발송 테스트 보강
    * 이메일 인증 링크 base-url 설정 추가
    * prod 이메일 인증 base-url 설정 추가

* **2026-01-22**

    * 게시글 API 페이징 및 JWT 기반 컨트롤러 추가
    * 게시글 관련 통합 테스트 보강 및 CommonException 처리 추가

* **2026-01-21**

    * 인증 통합 테스트 및 전역 예외 처리 리팩터링 완료
    * 게시글 CRUD 컨트롤러 테스트 및 엔티티 테스트 설정 보완
* **2026-01-20**

    * JWT Phase 1 완료
    * User/Role + 게시글 도메인 엔티티 구축
    * 테스트/문서/로그 프로토콜 정비
* **2026-01-19**

    * 환경 설정 분리 및 템플릿 정리

---

## 6. 작업 에이전트 워크플로우

1. 작업을 기능/변경 단위로 분리한다.
2. 단위 작업마다 코드 수정 → 관련 테스트 실행 → 커밋을 순서대로 수행한다.
3. 모든 단위 작업 완료 후, 전체 테스트(예: `./gradlew test`)를 한 번 더 실행한다.

---

## 7. Context7 MCP 사용법

### 기본 명령어
- **라이브러리 ID 확인**: `@context7 resolve-library-id <libraryName>`
- **문서 조회**: `@context7 query-docs <libraryId> <query>`

### 예시
```
@context7 resolve-library-id spring-boot
@context7 query-docs /springframework/spring-boot "JPA 설정 방법"
```

### 주요 라이브러리 ID
- Spring Boot: `/springframework/spring-boot`
- Spring Security: `/springframework/spring-security`
- JPA/Hibernate: `/hibernate/hibernate-orm`
- Redis: `/redis/redis`
- JWT: `/jwt/jjwt`
- Testcontainers: `/testcontainers/testcontainers-java`
- H2 Database: `/h2database/h2`
- Lombok: `/projectlombok/lombok`
- QueryDSL: `/querydsl/querydsl`
- Flyway: `/flyway/flyway`
