services:
  app:
    image: ${APP_IMAGE:?APP_IMAGE is required}
    container_name: backbackback-app
    restart: always
    env_file:
      - ${ENV_FILE:-/etc/backbackback/backbackback.env}
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      REDIS_HOST: ${REDIS_HOST_DOCKER:-redis}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      APP_AI_JOB_KAFKA_ENABLED: ${APP_AI_JOB_KAFKA_ENABLED:-true}
      # 앱은 무조건 컨테이너 내부 마운트 경로를 바라봅니다.
      JWT_KEYS_PUBLIC_KEY_PATH: /secrets/jwt/public.pem
      JWT_KEYS_PRIVATE_KEY_PATH: /secrets/jwt/private.pem
    ports:
      - "${SERVER_PORT:-8080}:8080"
    depends_on:
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    volumes:
      # 호스트의 키 위치(JWT_HOST_PATH)를 컨테이너 내부(/secrets/jwt)로 연결
      - ${JWT_HOST_PATH:?JWT_HOST_PATH is required}:/secrets/jwt:ro
      - ${UPLOAD_HOST_PATH:-/var/app/uploads}:/var/app/uploads
      - ${LOG_HOST_PATH:-/var/log/backbackback}:/var/log/backbackback

  redis:
    image: redis:7.0
    container_name: project-redis
    restart: always
    command:
      - /bin/sh
      - -c
      - >
        if [ -n "$$REDIS_PASSWORD" ]; then
          exec redis-server --appendonly yes --requirepass "$$REDIS_PASSWORD";
        else
          exec redis-server --appendonly yes;
        fi
    env_file:
      - ${ENV_FILE:-/etc/backbackback/backbackback.env}
    volumes:
      - redis-data:/data
    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  kafka:
    image: apache/kafka:3.7.0
    container_name: project-kafka
    restart: always
    environment:
      - KAFKA_NODE_ID=1
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_LOG_DIRS=/var/lib/kafka/data/kraft-combined-logs
      - KAFKA_HEAP_OPTS=-Xms256m -Xmx512m
    ports:
      - "127.0.0.1:${KAFKA_PORT:-9092}:9092"
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "bash -ec 'exec 3<>/dev/tcp/127.0.0.1/9092'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 20s

volumes:
  redis-data:
  kafka-data:
